# GPS Tracker v0.1a — NMEA Parser & Formatter

## Overview

A Python program that reads NMEA 0183 sentences from stdin or a file,
parses them into structured GPS data, and prints human-readable output
to stdout. This is the software-only, hardware-independent component
of v0.1. No GPS hardware is required to develop or test this program.

## Runtime Environment

- Raspberry Pi Zero (ARM11, 512MB RAM), Raspberry Pi OS Lite
- Python 3.9+
- Standard library only — no third-party dependencies

## Input

NMEA 0183 sentences, one per line, from either:
- **stdin** (default, streaming — does not wait for EOF)
- **a file path** passed as the first command-line argument

### Supported Sentence Types

**GGA — Global Positioning System Fix Data**

```
$GNGGA,092725.00,4104.7041,N,02858.9012,E,1,08,1.01,58.3,M,37.2,M,,*XX
```

| Field | Index | Description                    |
|-------|-------|--------------------------------|
| Time  | 1     | HHMMSS.ss UTC                  |
| Lat   | 2     | DDmm.mmmm                     |
| N/S   | 3     | N or S                         |
| Lon   | 4     | DDDmm.mmmm                    |
| E/W   | 5     | E or W                         |
| Fix   | 6     | 0=no fix, 1=GPS, 2=DGPS       |
| Sats  | 7     | Number of satellites in use    |
| HDOP  | 8     | Horizontal dilution of precision |
| Alt   | 9     | Altitude above mean sea level  |
| AltU  | 10    | Altitude units (M=meters)      |

**RMC — Recommended Minimum Navigation Information**

```
$GNRMC,092725.00,A,4104.7041,N,02858.9012,E,0.152,,230394,,,A*XX
```

| Field   | Index | Description                     |
|---------|-------|---------------------------------|
| Time    | 1     | HHMMSS.ss UTC                   |
| Status  | 2     | A=active (valid), V=void        |
| Lat     | 3     | DDmm.mmmm                      |
| N/S     | 4     | N or S                          |
| Lon     | 5     | DDDmm.mmmm                     |
| E/W     | 6     | E or W                          |
| Speed   | 7     | Speed over ground in knots      |
| Heading | 8     | Track angle in degrees (true)   |
| Date    | 9     | DDMMYY                          |

### Talker IDs

The NEO-8M is multi-constellation and may use any of these prefixes:
GP (GPS), GN (multi-GNSS), GL (GLONASS), GA (Galileo), GB (BeiDou).
The parser must accept any two-letter talker ID. Match sentence type
by the three letters after the talker ID (GGA, RMC).

### Other Sentence Types

The GPS module emits many other sentence types (GSV, GSA, VTG, GLL,
TXT, etc.). These must be silently ignored — no output, no error.

---

## Processing Rules

### 1. Checksum Validation

Every NMEA sentence ends with `*HH` where HH is a two-digit hex
checksum. The checksum is the XOR of all ASCII bytes between `$` and
`*` (exclusive of both). Sentences with invalid or missing checksums
must be silently discarded.

### 2. Coordinate Conversion

NMEA encodes coordinates as DDmm.mmmm (degrees and decimal minutes).
Convert to decimal degrees:

```
DDmm.mmmm → DD + (mm.mmmm / 60)
```

Examples:
- `4104.7041,N` → +41.078402°  (41 + 04.7041/60)
- `02858.9012,E` → +28.981687° (28 + 58.9012/60)
- Southern/Western hemispheres are negative.

Precision: 6 decimal places (±0.11m accuracy, well within GPS error).

### 3. Speed Conversion

RMC provides speed in knots. Convert to km/h:

```
km/h = knots × 1.852
```

### 4. Fix Correlation

GGA and RMC sentences with the same UTC timestamp belong to the same
fix. The program should combine data from both to produce a single
output line per fix:

- From GGA: fix quality, satellite count, altitude, HDOP
- From RMC: date (GGA has no date), speed, heading, validity status

A complete fix requires at minimum: latitude, longitude, and UTC time.
If only one sentence type is available for a given timestamp, output
what you have and use `---` for missing fields.

### 5. No-Fix Handling

A fix is invalid when:
- GGA fix_quality = 0, OR
- RMC status = 'V'

When there is no valid fix, output a no-fix line (see Output Format).

### 6. Robustness

The program must not crash on:
- Truncated sentences
- Empty lines
- Non-NMEA text (e.g., u-blox binary protocol preambles)
- Missing fields within otherwise valid sentences
- Any garbage data mixed with valid sentences

Invalid input is silently discarded. Valid sentences continue to parse.

---

## Output Format

All output goes to stdout. One line per event.

### Startup Line (printed once at launch)

```
GPS Parser v0.1a — reading from {source}...
```

Where `{source}` is `stdin` or the filename.

### Data Line (valid fix)

```
2024-03-23T09:27:25Z  41.078402  28.981687  0.28km/h  HDG:---  ALT:58.3m  SAT:08  HDOP:1.01  FIX:1
```

Field specification:
- Timestamp: ISO 8601 UTC, always with `Z` suffix
- Latitude: signed decimal degrees, 6 decimal places, space-padded to 11 chars
- Longitude: signed decimal degrees, 6 decimal places, space-padded to 12 chars
- Speed: 2 decimal places, followed by `km/h`
- Heading: 1 decimal place, or `---` if not available
- Altitude: 1 decimal place in meters, or `---` if not available
- Satellites: zero-padded 2-digit integer
- HDOP: 2 decimal places, or `---` if not available
- Fix quality: integer (0, 1, or 2)

Fields are separated by two spaces.

### No-Fix Line

```
2024-03-23T09:27:25Z  NO_FIX  SAT:03
```

If timestamp is unavailable (no RMC date yet), use:
```
--:--:--  NO_FIX  SAT:00
```

### Separator (between sessions, file mode only)

When there is a gap of >5 seconds between consecutive timestamps
(suggesting the module restarted or lost/regained fix), print:

```
--- gap: 47s ---
```

---

## Command-Line Interface

```
python gps_parser.py                    # read from stdin, stream mode
python gps_parser.py recording.nmea     # read from file, exit when done
python gps_parser.py --help             # print usage and exit
```

No other flags or options for v0.1a.

---

## Acceptance Tests

All tests run without GPS hardware. Tests use fixture files containing
NMEA sentences (see Fixture Data section below).

### T1 — Valid Fix Parsing

**Given:** A fixture file containing a matching GGA+RMC pair with valid fix.
**Then:** Output contains exactly one data line with correct lat, lon,
timestamp, speed, satellite count, and altitude.

### T2 — Coordinate Conversion Accuracy

**Given:** GGA containing `4104.7041,N` and `02858.9012,E`.
**Then:** Output lat = `41.078402` (±0.000001), lon = `28.981687` (±0.000001).

### T3 — Southern/Western Hemisphere

**Given:** GGA containing `3402.5432,S` and `11832.1099,W`.
**Then:** Output lat = `-34.042387`, lon = `-118.535165` (±0.000001).

### T4 — Speed Conversion

**Given:** RMC with speed field `5.400`.
**Then:** Output contains `10.00km/h`.

### T5 — No-Fix Output

**Given:** GGA with fix_quality=0 and 3 satellites visible.
**Then:** Output contains `NO_FIX  SAT:03`. No data line is produced.

### T6 — Checksum Validation

**Given:** A sentence with an incorrect checksum followed by a valid sentence.
**Then:** The bad sentence produces no output. The valid sentence parses correctly.

### T7 — Malformed Input Resilience

**Given:** A file containing: an empty line, a truncated sentence, random
ASCII garbage, and then a valid GGA+RMC pair.
**Then:** Program does not crash. The valid pair produces correct output.

### T8 — Missing Optional Fields

**Given:** RMC with empty heading field and GGA with empty altitude field.
**Then:** Output shows `HDG:---` and `ALT:---`. No crash.

### T9 — Stdin Streaming Behavior

**Given:** Data piped to stdin line by line (e.g., `cat fixture.nmea | python gps_parser.py`).
**Then:** Output appears incrementally as fixes are completed, not buffered until EOF.

### T10 — File Mode Exit

**Given:** Invoked with a file path argument.
**Then:** Program processes the entire file and exits with code 0.

### T11 — Startup Message

**Then:** First line of output matches the startup line format.

### T12 — Unrecognized Sentence Types Ignored

**Given:** Input contains GSV, GSA, VTG, and TXT sentences mixed with GGA/RMC.
**Then:** No output is produced for the non-GGA/RMC sentences. No errors.

### T13 — Multiple Talker IDs

**Given:** Input contains `$GPGGA,...` and `$GNRMC,...` with matching timestamps.
**Then:** They are correlated into a single fix and produce one data line.

---

## Fixture Data

### Generating Fixtures

The best fixture data comes from real hardware. Before the first Ralph
loop run, capture data from the NEO-8M:

```bash
# On the Pi Zero with GPS module connected:
# (stty handles UART config, cat captures raw output)
stty -F /dev/ttyS0 9600 raw
cat /dev/ttyS0 > fixtures/real_capture.nmea
# Let it run 2-3 minutes outdoors (for fix), then Ctrl+C
```

Save three fixture files:
1. `fixtures/sample_with_fix.nmea` — at least 30 seconds of data with a valid fix
2. `fixtures/sample_cold_start.nmea` — data from power-on through fix acquisition
3. `fixtures/sample_malformed.nmea` — valid data with injected errors (bad checksums, truncated lines, garbage bytes, empty lines)

If hardware is not yet available, the Ralph loop's first task should be
to generate synthetic NMEA fixture data with correct checksums for all
three scenarios above. The synthetic data should use coordinates in a
realistic range and simulate movement (changing lat/lon and non-zero speed).

---

## Out of Scope for v0.1a

These are explicitly NOT part of this milestone:
- UART/serial port communication (that's v0.1b)
- Writing data to files or databases (that's v0.2)
- Auto-start on boot (that's v0.2)
- Any network, Bluetooth, or display functionality
- Configuration files or environment variables
- Logging framework (stdout is the only output)
- Performance optimization (1Hz GPS data is trivially low throughput)
